/**
 * BIM数据目录树的解析, 扩展Cesium3DTileset类
 * 解析目录树需要满足3dtiles数据源下有 scenetree.json或info/index.json文件
 * @description
 *    bim-catalog.js\bim-catalog.min.js使用需要注意以下几点：
 *    1. 插件依赖于Cesium变量，页面必须先引用Cesium.js;
 *       <script src="Build/Cesium.js" type="text/javascript"></script>
 *       <script src="bim-catalog.min.js" type="text/javascript"></script>
 *    2. 插件创建目录树依赖于ztree组件，页面必须引用JQuery和ztree组件，具体如下:
 *       <!-- ztree样式 -->
 *       <link rel="stylesheet" href="js/libs/tree/css/bootstrapStyle/bootstrapStyle.css" type="text/css" />
 *       <!-- JQuery -->
 *       <script src="js/jquery-min.js" type="text/javascript"></script>
 *       <!-- ztree.core -->
 *       <script src="js/libs/tree/js/jquery.ztree.core-3.5.min.js" type="text/javascript"></script>
 *       <!-- ztree.excheck -->
 *       <script src="js/libs/tree/js/jquery.ztree.excheck-3.5.min.js" type="text/javascript"></script>
 * 
 * @author liuyimeng@KQGIS  2020-01-06 01:08
 * 
 */
var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(d,q,t){if(t.get||t.set)throw new TypeError("ES3 does not support getters and setters.");d!=Array.prototype&&d!=Object.prototype&&(d[q]=t.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(d){return $jscomp.SYMBOL_PREFIX+(d||"")+$jscomp.symbolCounter_++};$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(d){var q=0;return $jscomp.iteratorPrototype(function(){return q<d.length?{done:!1,value:d[q++]}:{done:!0}})};$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};$jscomp.makeIterator=function(d){$jscomp.initSymbolIterator();var q=d[Symbol.iterator];return q?q.call(d):$jscomp.arrayIterator(d)};(function(){function d(a,c,b,e,p,d,l){this.data=a;this.key=c;this.treeParentKey=this.parentKey=b;this.treeKey=c;this.parentTreeKey=b;if(this.map=e)e[c]&&(this.treeKey=e[c]),e[b]&&(this.parentTreeKey=e[b]);this.toTree=function(){for(var b=this.data,a={},c=[],f=0;0!=b.length;){if(0==b[f][this.parentKey]||-1==b[f][this.parentKey]){var n=this.copy(b[f],!0);c.push(n);a[b[f][this.key]]=[c.length-1];b.splice(f,1);f--}else{var m=a[b[f][this.parentKey]];if(void 0!=m){var e=c[m[0]];e.children||(e.children=[]);for(n=1;n<m.length;n++)e=e.children[m[n]];n=this.copy(b[f]);e.children||(e.children=[]);e.children.push(n);a[b[f][this.key]]=m.concat([e.children.length-1]);b.splice(f,1);f--}}f++;f>b.length-1&&(f=0)}return c};this.copy=function(b,c){var a={};a[this.treeKey]=d?d+b[this.key]:b[this.key];a[this.parentTreeKey]=c?d?d:b[this.parentKey]:d?d+b[this.parentKey]:b[this.parentKey];c=p||b;for(var f in c)f!=this.key&&f!=this.parentKey&&(c=b[f],this.map&&this.map[f]?a[this.map[f]]=c:a[f]=c);l&&l.filter&&(l.filter(b)?l.resolve(b,a):l.reject(b,a));return a}}function q(a){var c={};a=[a];for(var b=[c],e=[],p=[];0<a.length;){var d=a.shift(),l=b.shift();e.push(d);p.push(l);for(var g in d){var h=d[g];if("object"!==typeof h)l[g]=h;else{var k=e.indexOf(h);0<=k?l[g]=p[k]:(a.push(h),l[g]={},b.push(l[g]))}}}return c}if(!Cesium)throw console.log("\u7f3a\u5c11Cesium\u5bf9\u8c61, bim-catalog\u6269\u5c55\u521d\u59cb\u5316\u5931\u8d25"),Error("\u7f3a\u5c11Cesium\u5bf9\u8c61");var t="unknown unknown layer catagory element model".split(" ");Cesium.Cesium3DTileset.prototype.extendCatalog=function(a){var c=this;c._catalogReady||(c._zTreeNodes=void 0,c._ztreeDOMContainers=[],c._zTreeDOMs=[],c._enableMultiPickFeatures=!1,c._pickScreenSpaceEventType=Cesium.ScreenSpaceEventType.LEFT_CLICK,c._pickedEvent=new Cesium.Event,c._pickedHighlightColor=Cesium.Color.YELLOW,c._pickedFeaturesColor=[],c._pickedFeatures=[],c._catalogLinkPropertyName=a||"DbId",c._highlightColor=Cesium.Color.YELLOW,c._highlightColorOther=Cesium.Color.WHITE.withAlpha(.3),c.__highlightValues||(c.__highlightValues=[]),c.__invisibleValues||(c.__invisibleValues=[]),c._catalogHandlerStyle=new Cesium.Cesium3DTileStyle({show:{evaluate:function(b){var a=c._catalogLinkPropertyName;if(b.hasProperty(a))return b=b.getProperty(a),c.__invisibleValues.includes(b)?!1:!0}},color:{evaluateColor:function(b,a){var e=c._catalogLinkPropertyName;b.hasProperty(e)&&(b=b.getProperty(e),c.__highlightValues.includes(b)?Cesium.Color.clone(c._highlightColor,a):0==c.__highlightValues.length?Cesium.Color.clone(Cesium.Color.WHITE,a):Cesium.Color.clone(c._highlightColorOther,a));return a}}}),c.style=c._catalogHandlerStyle,c._catalogReady=!0)};Cesium.Cesium3DTileset.prototype.getCatalogLinkPropertyName=function(){return this._catalogLinkPropertyName};Cesium.Cesium3DTileset.prototype.setCatalogLinkPropertyName=function(a){a&&a!=this._catalogLinkPropertyName&&(this.__invisibleValues&&(this.__invisibleValues=[]),this.__highlightValues&&(this.__highlightValues=[]),this.makeStyleDirty(),this._catalogLinkPropertyName=a)};Cesium.Cesium3DTileset.prototype.getHighlightColor=function(){return{highlightColor:this._highlightColor,highlightColor:this._highlightColorOther}};Cesium.Cesium3DTileset.prototype.setHighlightColor=function(a,c){if(!this._catalogReady)throw Error("Please execute tileset.extendCatalog() first");var b=!1;a instanceof Cesium.Color&&a!==this._highlightColor&&(this._highlightColor=a,b=!0);c instanceof Cesium.Color&&c!==this._highlightColorOther&&(this._highlightColorOther=c,b=!0);b&&0<this.__highlightValues.length&&this.makeStyleDirty()};Cesium.Cesium3DTileset.prototype.setFeatureVisibleMaskByLinkValues=function(a,c){if(!this._catalogReady)throw Error("Please execute tileset.extendCatalog() first");if(Cesium.defined(a)&&this.__invisibleValues){a instanceof Array||(a=[a]);var b=this,e=!1;c=Cesium.defaultValue(c,!0);a.forEach(function(a){c?(a=b.__invisibleValues.indexOf(a),0<=a&&(b.__invisibleValues.splice(a,1),e=!0)):b.__invisibleValues.includes(a)||(b.__invisibleValues.push(a),e=!0)});e&&(this.style!==this._catalogHandlerStyle&&(this.style=this._catalogHandlerStyle),b.makeStyleDirty())}};Cesium.Cesium3DTileset.prototype.showAllFeatures=function(){if(!this._catalogReady)throw Error("Please execute tileset.extendCatalog() first");this.__invisibleValues&&0<this.__invisibleValues.length&&(this.__invisibleValues=[],this.style!==this._catalogHandlerStyle&&(this.style=this._catalogHandlerStyle))};Cesium.Cesium3DTileset.prototype.highlightFeaturesByLinkValues=function(a,c){if(!this._catalogReady)throw Error("Please execute tileset.extendCatalog() first");if(Cesium.defined(a)&&this.__highlightValues){a instanceof Array||(a=[a]);var b=this,e=!1;c&&(b.__highlightValues=[],e=!0);a.forEach(function(a){b.__highlightValues.includes(a)||(b.__highlightValues.push(a),e=!0)});e&&(this.style!==this._catalogHandlerStyle&&(this.style=this._catalogHandlerStyle),b.makeStyleDirty())}};Cesium.Cesium3DTileset.prototype.unhighlightFeaturesByLinkValues=function(a){if(!this._catalogReady)throw Error("Please execute tileset.extendCatalog() first");if(Cesium.defined(a)&&this.__highlightValues){a instanceof Array||(a=[a]);var c=this,b=!1;a.forEach(function(a){a=c.__highlightValues.indexOf(a);0<=a&&(c.__highlightValues.splice(a,1),b=!0)});b&&(this.style!==this._catalogHandlerStyle&&(this.style=this._catalogHandlerStyle),this.makeStyleDirty())}};Cesium.Cesium3DTileset.prototype.unhighlightAllFeature=function(){if(!this._catalogReady)throw Error("Please execute tileset.extendCatalog() first");this.__highlightValues&&(this.__highlightValues=[],this.style!==this._catalogHandlerStyle&&(this.style=this._catalogHandlerStyle),this.makeStyleDirty())};Cesium.Cesium3DTileset.prototype.getPickedEvent=function(){return this._pickedEvent};Cesium.Cesium3DTileset.prototype.getEnablePickFeatures=function(){return{enabled:this._pickedHandler?!0:!1,screenSpaceEventType:this._pickScreenSpaceEventType}};Cesium.Cesium3DTileset.prototype.setEnablePickFeatures=function(a,c,b){function e(b,a){var c=new Cesium.Entity;b.selectedEntity=c;g._enableMultiPickFeatures||(g._pickedFeatures.forEach(function(b,a){b.color=g._pickedFeaturesColor[a]}),g._pickedFeatures=[],g._pickedFeaturesColor=[]);g._pickedFeatures.includes(a)||(g._pickedFeatures.push(a),g._pickedFeaturesColor.push(a.color.clone()));a.color=g._pickedHighlightColor;b=l(a);-1==b?(c=d(a,c),g._pickedEvent.raiseEvent({feature:a,properties:c.properties,tableHTML:c.html})):r(a,c,b).then(function(b){g._pickedEvent.raiseEvent({feature:a,properties:b.properties,tableHTML:b.html})})}function d(b,a){var c={},f=b.getPropertyNames()||[],d="\u5c5e\u6027\u8868(Feature Property)";f.indexOf("name")&&(d=b.getProperty("name"));a.name=d;a.description='Loading \x3cdiv class\x3d"cesium-infoBox-loading"\x3e\x3c/div\x3e';var e="";f.forEach(function(a){c[a]=b.getProperty(a);"id"!==a.toLowerCase()&&(e=e+"\x3ctr\x3e\x3cth\x3e"+a+"\x3c/th\x3e\x3ctd\x3e"+b.getProperty(a)+"\x3c/td\x3e\x3c/tr\x3e")});f='\x3ctable class\x3d"cesium-infoBox-defaultTable"\x3e\x3ctbody\x3e'+e+"\x3c/tbody\x3e\x3c/table\x3e";a.description=f;return{html:f,properties:c}}function r(a,b,c){var f=g.basePath.indexOf("?"),e={url:(0<=f?g.basePath.substring(0,f):g.basePath)+"/info/"+parseInt(c/100)+".json"};return new Promise(function(f,g){Cesium.Resource.fetchJson(e).then(function(a){a=a.data[c+""];b.name=a.name||"\x3cnull\x3e";var e=[];e.push('\x3ctable class\x3d"cesium-infoBox-defaultTable"\x3e\x3ctbody\x3e');for(var d=$jscomp.makeIterator(a.categories),g=d.next();!g.done;g=d.next())for(var g=g.value,n=g.props,m=g.count,l=!1,k=0;k<m;k++)if(!n.flags[k]){l||(l=!0,e.push("\x3ctr\x3e\x3cth colspan\x3d2\x3e"+g.name+"\x3c/th\x3e\x3c/tr\x3e"));var h=n.values[k];switch(n.types[k].toLowerCase()){case "boolean":h=h?"YES":"NO";break;case "double":h=n.units[k]?h.toFixed(3)+" "+n.units[k]:""+h.toFixed(3);break;default:h+=""}e.push("\x3ctr\x3e\x3cth\x3e"+n.names[k]+"\x3c/th\x3e\x3ctd\x3e"+h+"\x3c/td\x3e\x3c/tr\x3e")}e.push("\x3c/tbody\x3e\x3c/table\x3e");e=e.join("");b.description=e;f({html:e,properties:a})},function(c){c=d(a,b);f({html:c.html,properties:c.properties})})})}function l(a){return Cesium.defined(a)&&Cesium.defined(a.getProperty)?parseInt(a.getProperty("DbId"),10):-1}var g=this;if(c){if(this._pickScreenSpaceEventType=b=Cesium.defaultValue(b,Cesium.ScreenSpaceEventType.LEFT_CLICK),!this._pickedHandler||this._pickScreenSpaceEventType!=b){if(!Cesium.defined(g._viewer)&&!Cesium.defined(a))throw Error("viewer is required for setEnablePickFeatures.");g._viewer=a||g._viewer;this._pickedHandler&&this._pickedHandler.destroy();this._pickedHandler=void 0;var h=a.scene;this._pickedHandler=new Cesium.ScreenSpaceEventHandler(h.canvas);this._pickedHandler.setInputAction(function(b){h.mode!==Cesium.SceneMode.MORPHING&&(b=h.pick(b.position||b.endPosition),Cesium.defined(b)&&b instanceof Cesium.Cesium3DTileFeature&&b.tileset==g&&e(a,b))},this._pickScreenSpaceEventType)}}else this.clearPickedFeaturesHighlight(),this._pickedHandler&&this._pickedHandler.destroy(),this._pickedHandler=void 0};Cesium.Cesium3DTileset.prototype.getEnableMultiPickFeatures=function(){return this._enableMultiPickFeatures};Cesium.Cesium3DTileset.prototype.setEnableMultiPickFeatures=function(a){Ceisum.defined(a)&&a!=this._enableMultiPickFeatures&&(this._enableMultiPickFeatures=a)};Cesium.Cesium3DTileset.prototype.clearPickedFeaturesHighlight=function(){var a=this;this._pickedFeatures.forEach(function(c,b){c.color=a._pickedFeaturesColor[b]});this._pickedFeatures=[];this._pickedFeaturesColor=[];this._viewer&&(this._viewer.selectedEntity=null)};Cesium.Cesium3DTileset.prototype.clearAllFeatureHighlight=function(){this.unhighlightAllFeature();this.clearPickedFeaturesHighlight()};Cesium.Cesium3DTileset.prototype.getZtreeNodes=function(a){function c(a,c,r){Cesium.Resource.fetchJson(a).then(function(a){var e;a=(a=a.db)||{};var h=[],k=[];try{e=a.externalIds.length-1;for(var f=[-1,2],n=1;n<=e;n++){var m=n,p=n,l=a.types[m];if(1<=m&&-1==f.indexOf(l)){var r={id:a.externalIds[m],name:a.names[m],type:t[a.types[m]]||"unknown",dbId:p,externalId:a.externalIds[m],category:a.categories[m],propPackId:a.propPackIds[m],sphere:null,boundingBox:a.boundingBoxes[m],parentId:a.parentIds[m],props:"",open:-1==a.parentIds[m]?!0:!1,checked:!b.__invisibleValues.includes(p)};Cesium.defined(r[b._catalogLinkPropertyName])||(r[b._catalogLinkPropertyName]=p);k.push(r)}}h=(new d(k,"dbId","parentId")).toTree()}catch(u){console.log(u)}e=h;b._zTreeNodes=e;c(e)},function(a){c([])})}var b=this;a=Cesium.defaultValue(a,!0);if(!b._catalogReady)throw Error("Please execute tileset.extendCatalog() first");return new Promise(function(e,d){if(b._zTreeNodes)e(b._zTreeNodes);else{b._zTreeNodes=[];var p=b.basePath.indexOf("?"),p=0<=p?b.basePath.substring(0,p):b.basePath,l={url:p+"/scenetree.json"},g={url:p+"/info/index.json"};a?Cesium.Resource.fetchJson(l).then(function(a){a instanceof Array?a[0].open=!0:a&&(a.open=!0);b._zTreeNodes=a;e(a)},function(a){c(g,e,d)}):c(g,e,d)}})};Cesium.Cesium3DTileset.prototype.initializeZTreeDOM=function(a,c,b,e){var d=this;c=Cesium.defaultValue(c,this._viewer);if(!this._catalogReady)throw console.log("Please execute tileset.extendCatalog() first."),Error("Please execute tileset.extendCatalog() first.");a?"string"==typeof a&&(a=document.getElementById(a)):a=document.body;var r={enable:!0,autoCheckTrigger:!0},l={simpleData:{enable:!0}},g={onClick:function(a,b,e){if(a=c){b=e.boundingBox;var f=e.sphere;if(b||f){if(f)b=f[3],b=new Cesium.BoundingSphere(new Cesium.Cartesian3(f[0],f[1],f[2]),b);else{var f=b[3],g=b[4],m=b[5];b=Cesium.BoundingSphere.transform(Cesium.BoundingSphere.fromCornerPoints(new Cesium.Cartesian3(b[0],b[1],b[2]),new Cesium.Cartesian3(f,g,m)),d.root.computedTransform,new Cesium.BoundingSphere)}a=a.scene.camera;f=new Cesium.HeadingPitchRange(a.heading,a.pitch,0);a.flyToBoundingSphere(b,{offset:f,duration:1})}}d.highlightFeaturesByLinkValues(e[d._catalogLinkPropertyName],!0)},onCheck:function(a,b,c){d.setFeatureVisibleMaskByLinkValues(c[d._catalogLinkPropertyName],c.checked)},onRightClick:function(a,b,c){d.clearAllFeatureHighlight()}};if("object"!=typeof b||null==b)b={};if("object"!=typeof b.check||null==b.check)b.check=r;b.check.autoCheckTrigger=!0;if("object"!==typeof b.data||null==b.data)b.data=l;if("object"!=typeof b.data.simpleData||null==b.data.simpleData)b.data.simpleData={enable:!0};b.data.simpleData.enable=!0;if("object"!==typeof b.callback||null==b.callback)b.callback={};var h=q(b);h.callback.onClick="function"!==typeof b.callback.onClick?g.onClick:function(a,c,d){g.onClick(a,c,d);b.callback.onClick(a,c,d)};h.callback.onCheck="function"!==typeof b.callback.onCheck?g.onCheck:function(a,c,d){g.onCheck(a,c,d);b.callback.onCheck(a,c,d)};h.callback.onRightClick="function"!==typeof b.callback.onRightClick?g.onRightClick:function(a,c,d){g.onRightClick(a,c,d);b.callback.onRightClick(a,c,d)};var k=document.createElement("div");k.className="ztree";k.id="ztree_"+Cesium.createGuid();a.appendChild(k);d._zTreeDOMs.push(k);d._ztreeDOMContainers.push(k);return new Promise(function(b,c){if(d._zTreeNodes){var f=$.fn.zTree.init($(k),h,d._zTreeNodes);b({treeObj:f,zTreeDOM:k,ztreeDOMContainer:a});f.checkAllNodes(d.show)}else d.getZtreeNodes(e).then(function(c){c=$.fn.zTree.init($(k),h,c);b({treeObj:c,zTreeDOM:k,ztreeDOMContainer:a});c.checkAllNodes(d.show)},function(a){c()})})};Cesium.Cesium3DTileset.prototype.destroyZTreeDOM=function(){if(this._zTreeDOMs){var a=this;this._zTreeDOMs.forEach(function(c,b){try{a._ztreeDOMContainers[b].removeChild(c)}catch(e){}});this._zTreeDOMs=[];a._ztreeDOMContainers=[]}}})();
//# sourceMappingURL=bim-catalog.min.js.map
